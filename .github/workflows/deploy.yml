name: Deploy to Linux Server via SSH Password

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      APP_DIR: ${{ secrets.APP_DIR || '/home/' }}${{ secrets.SSH_USER }}/multitable-timer
      SSH_HOST: ${{ secrets.SSH_HOST }}
      SSH_USER: ${{ secrets.SSH_USER }}
      SSHPASS: ${{ secrets.SSH_PASS }}
      SSH_PORT: ${{ secrets.SSH_PORT || '22' }}   # optional: add SSH_PORT secret if you use a non-standard port
      SSH_OPTS: "-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -p ${{ secrets.SSH_PORT || '22' }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install rsync & sshpass
        run: sudo apt-get update && sudo apt-get install -y rsync sshpass

      # Option A: trust host key once (safer). Keep this step AND still keep SSH_OPTS as a fallback.
      - name: Add host key to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p "$SSH_PORT" -H "$SSH_HOST" >> ~/.ssh/known_hosts || true

      - name: Create target dir on server (and install rsync if missing)
        run: |
          sshpass -e ssh $SSH_OPTS "$SSH_USER@$SSH_HOST" \
            "mkdir -p '$APP_DIR' && (command -v rsync >/dev/null 2>&1 || (sudo apt-get update && sudo apt-get install -y rsync))"

      - name: Rsync project to server
        run: |
          sshpass -e rsync -az --delete \
            --exclude ".git" \
            --exclude ".github" \
            -e "ssh $SSH_OPTS" \
            ./ "$SSH_USER@$SSH_HOST:$APP_DIR/"

      - name: Install deps & (re)start with pm2
        run: |
          sshpass -e ssh $SSH_OPTS "$SSH_USER@$SSH_HOST" << 'EOF'
          set -e
          cd "$APP_DIR"
          if ! command -v node >/dev/null 2>&1; then
            sudo apt update && sudo apt install -y nodejs npm
          end_if_marker
          if ! command -v pm2 >/dev/null 2>&1; then
            sudo npm install -g pm2
          fi
          npm ci || npm install
          pm2 describe multitable >/dev/null 2>&1 && pm2 restart multitable || pm2 start server.js --name multitable
          pm2 save
          EOF
